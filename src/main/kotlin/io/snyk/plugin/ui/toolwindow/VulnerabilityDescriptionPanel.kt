package io.snyk.plugin.ui.toolwindow

import com.intellij.icons.AllIcons
import com.intellij.ide.BrowserUtil
import com.intellij.ui.components.JBLabel
import com.intellij.ui.components.labels.LinkLabel
import com.intellij.uiDesigner.core.GridConstraints
import com.intellij.uiDesigner.core.GridLayoutManager
import com.intellij.uiDesigner.core.Spacer
import icons.SnykIcons
import io.snyk.plugin.ui.buildBoldTitleLabel
import io.snyk.plugin.ui.buildTwoLabelsPanel
import io.snyk.plugin.ui.getReadOnlyClickableHtmlJEditorPane
import org.commonmark.parser.Parser
import org.commonmark.renderer.html.HtmlRenderer
import snyk.oss.Vulnerability
import java.awt.Color
import java.awt.Component
import java.awt.Dimension
import java.awt.Font
import java.awt.Insets
import javax.swing.JComponent
import javax.swing.JLabel
import javax.swing.JPanel

class VulnerabilityDescriptionPanel(private val groupedVulns: Collection<Vulnerability>) : JPanel() {

    private val labelProvider: LabelProvider = LabelProvider()
    private val vulnerability = groupedVulns.first()

    private fun baseGridConstraints(
        row: Int,
        column: Int = 0,
        rowSpan: Int = 1,
        colSpan: Int = 1,
        anchor: Int = GridConstraints.ANCHOR_WEST,
        fill: Int = GridConstraints.FILL_NONE,
        HSizePolicy: Int = GridConstraints.SIZEPOLICY_FIXED,
        VSizePolicy: Int = GridConstraints.SIZEPOLICY_FIXED,
        minimumSize: Dimension? = null,
        preferredSize: Dimension? = null,
        maximumSize: Dimension? = null,
        indent: Int = 1,
        useParentLayout: Boolean = false
    ): GridConstraints {
        return GridConstraints(
            row, column, rowSpan, colSpan, anchor, fill, HSizePolicy, VSizePolicy, minimumSize, preferredSize,
            maximumSize, indent, useParentLayout
        )
    }

    private fun panelGridConstraints(row: Int) = baseGridConstraints(
        row = row,
        anchor = GridConstraints.ANCHOR_CENTER,
        fill = GridConstraints.FILL_BOTH,
        HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
        VSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
        indent = 0
    )

    init {
        this.layout = GridLayoutManager(10, 1, Insets(20, 10, 20, 20), -1, 10)

        this.add(
            Spacer(),
            baseGridConstraints(
                9,
                anchor = GridConstraints.ANCHOR_CENTER,
                fill = GridConstraints.FILL_VERTICAL,
                HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK,
                VSizePolicy = GridConstraints.SIZEPOLICY_WANT_GROW,
                indent = 0
            )
        )

        this.add(
            getMainBodyPanel(),
            baseGridConstraints(1, indent = 0)
        )

        this.add(
            getDetailedPathsPanel(),
            panelGridConstraints(2)
        )

        this.add(
            getOverviewPanel(),
            panelGridConstraints(3)
        )

        this.add(
            getTitlePanel(),
            panelGridConstraints(0)
        )
    }

    private fun getMainBodyPanel(): JPanel {
        val panel = JPanel()
        panel.layout = GridLayoutManager(11, 2, Insets(20, 0, 20, 0), 50, -1)

        fun boldLabel(text: String) =
            JLabel(text).apply { font = io.snyk.plugin.ui.getFont(Font.BOLD, -1, JLabel().font) }

        panel.add(
            boldLabel("Vulnerable module:"),
            baseGridConstraints(2, 0)
        )
        panel.add(
            JLabel(vulnerability.name)/*.apply { this.horizontalAlignment = SwingConstants.LEFT }*/,
            baseGridConstraints(2, 1)
        )

        val introducedThroughListPanel = getIntroducedThroughListPanel()
        if (introducedThroughListPanel != null) {
            panel.add(
                boldLabel("Introduced through:"),
                baseGridConstraints(3, 0)
            )
            panel.add(
                introducedThroughListPanel,
                baseGridConstraints(3, 1)
            )
        }

        val fixedInText = vulnerability.fixedIn?.let {
            if (it.isNotEmpty()) {
                it.joinToString(prefix = "${vulnerability.name}@", separator = ", @")
            } else "Not fixed"
        }
        if (fixedInText != null) {
            panel.add(
                boldLabel("Fixed in:"),
                baseGridConstraints(4, 0)
            )
            panel.add(
                JLabel(fixedInText),
                baseGridConstraints(4, 1)
            )
        }

        val exploit = vulnerability.exploit
        if (exploit != null) {
            panel.add(
                boldLabel("Exploit maturity:"),
                baseGridConstraints(5, 0)
            )
            panel.add(
                JLabel(exploit),
                baseGridConstraints(5, 1)
            )
        }

        return panel
    }

    private fun getIntroducedThroughListPanel(): JPanel? {
        val intros = groupedVulns
            .mapNotNull { vulnerability ->
                vulnerability.from.let { if (it.size > 1) it[1] else null }
            }
            .distinct()

        if (intros.isEmpty()) return null

        val panel = JPanel()
        val packageManager = groupedVulns.first().packageManager

        panel.layout = GridLayoutManager(1, intros.size * 2, Insets(0, 0, 0, 0), 0, 0)

        addRowOfItemsToPanel(
            panel = panel,
            startingColumn = 0,
            items = intros.map { item -> labelProvider.getDependencyLabel(packageManager, item) },
            separator = ", ",
            firstSeparator = false,
            opaqueSeparator = false
        )
        return panel
    }

    private fun getDetailedPathsPanel(): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, -1)

        detailsPanel.add(
            buildBoldTitleLabel("Detailed paths"),
            baseGridConstraints(
                row = 0
            )
        )

        detailsPanel.add(
            getInnerDetailedPathsPanel(3),
            baseGridConstraints(
                row = 1,
                indent = 0
            )
        )

        return detailsPanel
    }

    private fun getInnerDetailedPathsPanel(itemsToShow: Int? = null): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(groupedVulns.size + 2, 2, Insets(0, 0, 0, 0), -1, -1)

        groupedVulns
            .take(itemsToShow ?: groupedVulns.size)
            .forEachIndexed { index, vuln ->
                val detailPanel = JPanel()
                detailPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, 0)
                detailPanel.add(
                    buildTwoLabelsPanel("Introduced through:", vuln.from.joinToString(separator = " > ")),
                    baseGridConstraints(
                        row = 0,
                        HSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                        VSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                        indent = 0
                    )
                )

                val remediationText = when {
                    vuln.upgradePath.isEmpty() || vuln.upgradePath.size < 2 -> "none"
                    else -> "Upgrade to " + vuln.upgradePath[1]
                }
                detailPanel.add(
                    buildTwoLabelsPanel("Remediation:", remediationText),
                    baseGridConstraints(
                        row = 1,
                        indent = 0
                    )
                )

                detailsPanel.add(
                    detailPanel,
                    baseGridConstraints(
                        row = index + 1
                    )
                )
            }

        if (itemsToShow != null && itemsToShow < groupedVulns.size) {
            val showMoreLabel = LinkLabel.create("...and ${groupedVulns.size - itemsToShow} more") {
                detailsPanel.removeAll()
                detailsPanel.add(
                    getInnerDetailedPathsPanel(),
                    baseGridConstraints(
                        row = 0,
                        indent = 0
                    )
                )
                this.revalidate()
                this.repaint()
            }
            detailsPanel.add(
                showMoreLabel,
                baseGridConstraints(groupedVulns.size + 1)
            )
        }

        return detailsPanel
    }

    private fun getTitlePanel(): JPanel {
        val titlePanel = JPanel()
        titlePanel.layout = GridLayoutManager(3, 1, Insets(0, 0, 0, 0), -1, 5)

        val titleLabel = JLabel().apply {
            font = io.snyk.plugin.ui.getFont(Font.BOLD, 20, font)
            text = " ${vulnerability.title}"
            icon = SnykIcons.getSeverityIcon(vulnerability.severity, SnykIcons.IconSize.SIZE24)
        }

        titlePanel.add(
            titleLabel,
            baseGridConstraints(0)
        )

        titlePanel.add(
            cwePanel(),
            baseGridConstraints(1, indent = 0)
        )

        if (vulnerability.language == "js" && vulnerability.title == "Prototype Pollution") {
            titlePanel.add(
                snykLearn(),
                baseGridConstraints(2, indent = 0)
            )
        }

        return titlePanel
    }

    private fun cwePanel(): Component {
        val panel = JPanel()
        val cwes = vulnerability.identifiers?.CWE ?: emptyArray()
        val cves = vulnerability.identifiers?.CVE ?: emptyArray()

        val columnCount = 1 + // `Vulnerability`/`License` label
            cwes.size * 2 + // CWEs with `|`
            cves.size * 2 + // CVEs with `|`
            2 + // CVSS
            2 // Snyk description
        panel.layout = GridLayoutManager(1, columnCount, Insets(0, 0, 0, 0), 5, 0)

        panel.add(
            JLabel(if (vulnerability.license == null) "Vulnerability" else "License"),
            baseGridConstraints(0)
        )

        var lastColumn =
            addRowOfItemsToPanel(panel, 0, cwes.map { cwe -> labelProvider.getCWELabel(cwe) })

        lastColumn =
            addRowOfItemsToPanel(panel, lastColumn, cves.map { cve -> labelProvider.getCVELabel(cve) })

        val cvssScore = vulnerability.cvssScore
        val cvsSv3 = vulnerability.CVSSv3
        if (cvssScore != null && cvsSv3 != null) {
            val label = listOf(labelProvider.getCVSSLabel("CVSS $cvssScore", cvsSv3))
            lastColumn =
                addRowOfItemsToPanel(panel, lastColumn, label)
        }

        val label = listOf(labelProvider.getVulnerabilityLabel(vulnerability.id.toUpperCase()))
        lastColumn =
            addRowOfItemsToPanel(panel, lastColumn, label)

        return panel
    }

    private fun snykLearn(): JPanel {
        val panel = JPanel(GridLayoutManager(1, 2, Insets(10, 0, 0, 0), 0, 0))

        val snykLearnIcon = JBLabel(SnykIcons.SNYK_LEARN)
        panel.add(snykLearnIcon, baseGridConstraints(0, 0))

        val snykLearnLink = LinkLabel.create("Learn more about Prototype pollution") {
            BrowserUtil.browse("https://learn.snyk.io/lessons/prototype-pollution/javascript/")
        }
        snykLearnLink.icon = AllIcons.Ide.External_link_arrow
        snykLearnLink.horizontalTextPosition = JLabel.LEFT
        snykLearnLink.iconTextGap = 0

        panel.add(snykLearnLink, baseGridConstraints(0, 1))

        return panel
    }

    private fun addRowOfItemsToPanel(
        panel: JPanel,
        startingColumn: Int,
        items: List<JLabel>,
        separator: String = " | ",
        firstSeparator: Boolean = true,
        opaqueSeparator: Boolean = true
    ): Int {
        var currentColumn = startingColumn
        items.forEach { item ->
            if (currentColumn != startingColumn || firstSeparator) {
                currentColumn++
                panel.add(
                    JLabel(separator).apply { if (opaqueSeparator) makeOpaque(this, 50) },
                    baseGridConstraints(0, column = currentColumn, indent = 0)
                )
            }
            currentColumn++
            panel.add(item, baseGridConstraints(0, column = currentColumn, indent = 0))
        }
        return currentColumn
    }

    private fun makeOpaque(component: JComponent, alpha: Int) {
        component.foreground = Color(
            component.foreground.red,
            component.foreground.green,
            component.foreground.blue,
            alpha
        )
    }

    private fun getOverviewPanel(): JPanel {
        val overviewPanel = JPanel()
        overviewPanel.layout = GridLayoutManager(2, 1, Insets(0, 5, 0, 0), -1, 0)

        val descriptionPane = getReadOnlyClickableHtmlJEditorPane(getDescriptionAsHtml())

        overviewPanel.add(
            descriptionPane,
            panelGridConstraints(1)
        )
        return overviewPanel
    }

    private fun getDescriptionAsHtml(): String {
        val overviewMarkdownStr = vulnerability.description

        val parser = Parser.builder().build()
        val document = parser.parse(overviewMarkdownStr)

        val renderer = HtmlRenderer.builder().escapeHtml(true).build()

        return renderer.render(document)
    }
}
